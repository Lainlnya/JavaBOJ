SELECT CC.CAR_ID, CC.CAR_TYPE, 
ROUND((1 - CD.DISCOUNT_RATE * 0.01) * CC.DAILY_FEE * 30) AS FEE
FROM CAR_RENTAL_COMPANY_CAR CC
JOIN CAR_RENTAL_COMPANY_RENTAL_HISTORY CR
ON CC.CAR_ID = CR.CAR_ID
JOIN CAR_RENTAL_COMPANY_DISCOUNT_PLAN CD
ON CC.CAR_TYPE = CD.CAR_TYPE
WHERE CC.CAR_TYPE IN ('세단', 'SUV')
AND CD.DURATION_TYPE = '30일 이상'
GROUP BY CC.CAR_ID
HAVING MAX(CR.END_DATE) < '2022-11-01'
AND FEE >= 500000 AND FEE < 2000000
ORDER BY FEE DESC, CC.CAR_TYPE, CC.CAR_ID DESC;